const axios = require("axios");
const FormData = require("form-data");
const cheerio = require("cheerio");
const fs = require("fs");
const path = require("path");

async function uploadImage(filePath) {
  try {
    const form = new FormData();
    form.append("file", fs.createReadStream(filePath));

    const uploadRes = await axios.post(
      "https://download1.imageonline.co/ajax_upload_file.php",
      form,
      {
        headers: {
          ...form.getHeaders(),
        },
      }
    );

    if (!uploadRes.data.isSuccess) throw new Error("Upload gagal");

    const uploadedFile = uploadRes.data.files[0];
    const uploadedFileName = uploadedFile.file.split("/").pop();

    const convertData = new URLSearchParams();
    convertData.append("name", uploadedFileName);
    convertData.append("originalname", path.basename(filePath));
    convertData.append("option3", "png");
    convertData.append("option4", "1");

    const convertRes = await axios.post(
      "https://download1.imageonline.co/pngmaker.php",
      convertData.toString(),
      {
        headers: {
          "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
        },
      }
    );

    const $ = cheerio.load(convertRes.data);
    const downloadLink = $("a.btn.fa-download").attr("href");

    if (!downloadLink) throw new Error("Gagal ambil link download");

    return downloadLink;
  } catch (err) {
    console.error(err);
  }
}

uploadImage("./Screenshot_20251001-194216.png").then((link) => {
  console.log("Download link:", link);
});